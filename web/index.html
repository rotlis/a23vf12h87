<html>
<head>
    <title>Better Build Lights</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon"
          type="image/png"
          href="favicon.png">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <style>
        .jumbotron{
            background-color: #6f5499;
            color:white;
        }
        #push,
        #footer {
            height: 60px;
        }
        #footer {
            padding-top: 20px;
            background-color: #f5f5f5;
        }
        /* Lastly, apply responsive CSS fixes as necessary */
        @media (max-width: 767px) {
            #footer {
                margin-left: -20px;
                margin-right: -20px;
                padding-left: 20px;
                padding-right: 20px;
            }
        }
    </style>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/mustache.js/mustache.js"></script>
    <script>
        var ws;
        $(function(){
            function connect() {
                console.log("Connecting...");
                ws = new WebSocket("ws://localhost:1880/ws/test");
                ws.onmessage = function(event){
                    console.debug("onmessage", event.data);
                    onNodeBeackon($.parseJSON(event.data));
                };
                ws.onopen = function() {
                    console.log("Connection is onopen");
                };
                ws.onclose = function() {
                    console.debug("Connection is closed...");
                    setTimeout(connect, 1000);
                };
            }
            connect();
        });
    </script>

    <script>

        var devices = {};
        var $xml;

        var nodeTemplate;

        var projects = [{name:"RNTD"}, {name:"Atlas"}, {name:"GoServerConfigurationPackage"}, {name:"MARCI"},
            {name:"MobAct-Prod"}, {name:"PhotoUpload"}, {name:"OnlineCustomers"}, {name:"Dev5-Showcase"}];

        function testCcTray(){
            $("#test_cctray").removeClass("btn-success").removeClass("btn-danger");
            $.ajax({
                url: "/proxy",
                type: "GET",
                data: { url: $("#cctray_url").val(), username :$("#username").val(), pwd:$("#pwd").val()} ,
                dataType: "xml",
                success: function(data) {
                    $xml = $( data );
                    $("#test_cctray").removeClass("btn-default").addClass("btn-success");
                },
                error: function(e) {
                    console.debug("Error",e);
                    $("#test_cctray").removeClass("btn-default").addClass("btn-danger");
                }
            });
        }

        function loadTemplates(){
            $("#templates").load("templates/templates.html#template1",function(){
                nodeTemplate = document.getElementById('template1').innerHTML;
            });
        }

        function addNode(nodeJson){
            var deviceId = nodeJson.mac;
            var selections = [];
            $.each(projects, function(){selections.push({name:this.name, selected:(this.name == nodeJson.project)});});
            var jsonData = {id:deviceId, node:nodeJson, projects:selections};
            var output = Mustache.render(nodeTemplate, jsonData);
            $("#devices-container").append(output);
            attachDeviceHandlers(deviceId);
            $("#"+deviceId).fadeIn();
        }

        function onNodeBeackon(json){
            if (devices[json.mac]){
                console.debug("Update for "+json.mac);
            }else{
                console.debug("Adding "+json.mac);
                devices[json.mac] = json;
                addNode(json);
            }
        }

        function onNodeDelete(json){
            delete devices[json.mac];
            $("#"+json.mac).fadeOut(400, function(){
                $("#"+json.mac).remove();
            });
        }

        function attachGlobalHandlers(){
            $("#test_cctray").click(testCcTray);
            $("#cctray_url, #username, #pwd").on('input', function(){
                $("#test_cctray").addClass("btn-default").removeClass("btn-danger").removeClass("btn-success");
            });
        }

        function attachDeviceHandlers(mac){
            $("#"+mac+" button.device-save").click(function(){
                console.log(mac+" device-save");
            });
            $("#"+mac+" button.device-identify").click(function(){
                console.log(mac+" device-identify");
            });
        }

        $(document).ready(function(){
            loadTemplates();
            attachGlobalHandlers();
        });

    </script>
</head>
<body>

<div id="templates" style="display: none;"></div>

<nav class="navbar navbar-default">   <!--navbar-fixed-top-->
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">BetterBuildLights</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="/">Home</a></li>
                <li><a href="#">Page 1</a></li>
                <li><a href="#">Page 2</a></li>
                <li><a href="#">Page 3</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Link 1</a></li>
                <li><a href="#">Link 2</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="jumbotron">
        <h1>Better Build Lights</h1>
        <p>When we eat our own dog food it got to be tasty one!</p>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading">GO server settings</div>
        <div class="panel-body">
            <div class="form-group">
                <label for="cctray_url">CCTRAY URL:</label>
                <input type="url" class="form-control" id="cctray_url" value="https://go.nbnco.net.au/go/cctray.xml">
            </div>
            <div class="form-group form-inline">
                <label for="username">Username:</label>
                <input type="username" class="form-control" id="username" placeholder="Enter username" value="dev">

                <label for="pwd">Password:</label>
                <input type="password" class="form-control" id="pwd" placeholder="Enter password" value="dev">
            </div>

            <button id="test_cctray" class="btn btn-default">Test</button>
            <button type="submit" class="btn btn-default">Save</button>
        </div>
    </div>

    <div id="devices-container" class="row">


    </div>

    <div class="panel panel-info">
        <div class="panel-heading">By 2018, The 'Internet Of Things' Will Be Bigger Than The Smartphone, Tablet, And PC Markets Combined</div>
        <div class="panel-body">
            The numbers being forecast for the Internet of Things (IoT) are truly mind-boggling.

            BI Intelligence finds that the number of everyday and enterprise devices that will soon be connected to the Internet — from parking meters to home thermostats — will be huge.
            1.9 billion devices today, and 9 billion by 2018, according to BII estimates, roughly equal to the number of smartphones, smart TVs, tablets, wearable computers, and PCs combined.

            It will drive trillions in economic value as it permeates consumer and business life.
            In the consumer space, many products and services have already crossed over into the IoT, including kitchen and home appliances, lighting and heating products.
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <h2>Thing</h2>
            <p>
                <a href="http://www.esp8266.com/wiki/doku.php?id=esp8266-module-family">ESP8266-ESP12</a> running <a href="http://nodemcu.com/index_en.html">nodemcu</a> firmware.
            </p>
            <p><a class="btn btn-default" href="#" role="button">View details</a></p>
        </div>
        <div class="col-md-4">
            <h2>Server</h2>
            <p>
                nodejs server with modules http, url, socket.io, xml2js, dgram.
            </p>
            <p><a class="btn btn-default" href="#" role="button">View details</a></p>
        </div>
        <div class="col-md-4">
            <h2>Browser</h2>
            <p>
                bootstrap, jquery, mustache, socket.io
            </p>
            <p><a class="btn btn-default" href="#" role="button">View details</a></p>
        </div>
    </div>


    <div id="push"></div>
</div>



<div id="footer">
    <div class="container">
        <p class="muted credit">Example courtesy TODO</p>
    </div>
</div>


</body>
</html>